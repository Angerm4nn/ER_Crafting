name: Deploy Blazor WASM to GitHub Pages (Auto-detect)
on:
  push:
    branches: [ master ]
permissions:
  contents: write
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      
      - name: Restore
        run: dotnet restore
      
      - name: Publish .NET Core Project
        run: dotnet publish ER_Crafting/ER_Crafting.csproj -c Release -o release --nologo
      
      - name: Find and fix base href
        run: |
          echo "Looking for index.html..."
          INDEX_PATH=$(find release -name "index.html" -type f | head -1)
          
          if [ -z "$INDEX_PATH" ]; then
            echo "Error: index.html not found anywhere in release directory"
            echo "Directory contents:"
            find release -type f | head -20
            exit 1
          fi
          
          echo "Found index.html at: $INDEX_PATH"
          
          # Fix the base href
          sed -i 's|<base href="/" />|<base href="/ER_Crafting/" />|' "$INDEX_PATH"
          echo "Updated base href in $INDEX_PATH"
          
          # Find the wwwroot directory (where the web files are)
          WWWROOT_PATH=$(dirname "$INDEX_PATH")
          echo "WWWROOT_PATH=$WWWROOT_PATH" >> $GITHUB_ENV
          echo "Web files are in: $WWWROOT_PATH"
      
      - name: SPA routing fix
        run: |
          touch $WWWROOT_PATH/.nojekyll
          cp $WWWROOT_PATH/index.html $WWWROOT_PATH/404.html
          echo "Created .nojekyll and 404.html in $WWWROOT_PATH"
      
      - name: Deploy to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: ${{ env.WWWROOT_PATH }}